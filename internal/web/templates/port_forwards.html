<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>端口转发 - NetLink</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="/static/logo.svg" alt="NetLink">
            <span class="logo-text">NetLink</span>
        </div>
        <nav class="nav">
            <a href="/">首页</a>
            <a href="/connections">连接</a>
            <a href="/logs">日志</a>
            <a href="/ssh-servers">SSH服务器</a>
            <a href="/port-forwards">端口转发</a>
            <a href="/http-proxy">HTTP代理</a>
        </nav>
    </header>
    <main class="container-full">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2>端口转发</h2>
                <button class="btn btn-primary" onclick="openModal()">添加转发</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>SSH服务器</th>
                        <th>本地</th>
                        <th>远程</th>
                        <th class="no-wrap">状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="forwardTable">
                    <tr><td colspan="6" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="modal" id="forwardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加端口转发</h3>
                <span style="cursor:pointer" onclick="closeModal()">&times;</span>
            </div>
            <form id="forwardForm">
                <input type="hidden" id="forwardId">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="forwardName" required>
                </div>
                <div class="form-group">
                    <label>SSH服务器</label>
                    <select id="forwardSSHServer" required>
                        <option value="">请选择</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>本地监听地址</label>
                    <input type="text" id="forwardListenHost" value="127.0.0.1" required>
                </div>
                <div class="form-group">
                    <label>本地端口</label>
                    <input type="number" id="forwardListenPort" required>
                </div>
                <div class="form-group">
                    <label>远程主机</label>
                    <input type="text" id="forwardRemoteHost" required>
                </div>
                <div class="form-group">
                    <label>远程端口</label>
                    <input type="number" id="forwardRemotePort" required>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select id="forwardEnabled">
                        <option value="false">禁用</option>
                        <option value="true">启用</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background:#e2e8f0" onclick="closeModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let servers = [];

        async function loadData() {
            const [serversData, forwardsData] = await Promise.all([
                fetch('/api/ssh-servers').then(r => r.json()),
                fetch('/api/port-forwards').then(r => r.json())
            ]);
            servers = serversData || [];
            renderTable(forwardsData);
        }
        function renderTable(forwards) {
            const forwardsList = forwards || [];
            const tbody = document.getElementById('forwardTable');
            if(forwardsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">暂无端口转发</td></tr>';
                return;
            }
            tbody.innerHTML = forwardsList.map(f => {
                const server = servers.find(s => s.id === f.ssh_server_id) || {};
                return `
                <tr>
                    <td>${f.name}</td>
                    <td>${server.name || '未知'}</td>
                    <td>${f.listen_host}:${f.listen_port}</td>
                    <td>${f.remote_host}:${f.remote_port}</td>
                    <td class="no-wrap">${f.enabled ? '已启用' : '已禁用'}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick="editForward('${f.id}', '${f.name}', '${f.ssh_server_id}', '${f.listen_host}', ${f.listen_port}, '${f.remote_host}', ${f.remote_port}, ${f.enabled})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteForward('${f.id}')">删除</button>
                    </td>
                </tr>
            `}).join('');
        }
        function openModal() {
            document.getElementById('modalTitle').textContent = '添加端口转发';
            document.getElementById('forwardForm').reset();
            const select = document.getElementById('forwardSSHServer');
            select.innerHTML = '<option value="">请选择</option>' + servers.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            document.getElementById('forwardModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('forwardModal').classList.remove('active');
        }
        function editForward(id, name, sshServerId, listenHost, listenPort, remoteHost, remotePort, enabled) {
            document.getElementById('modalTitle').textContent = '编辑端口转发';
            document.getElementById('forwardId').value = id;
            document.getElementById('forwardName').value = name;
            const select = document.getElementById('forwardSSHServer');
            select.innerHTML = servers.map(s => 
                `<option value="${s.id}" ${s.id === sshServerId ? 'selected' : ''}>${s.name}</option>`
            ).join('');
            document.getElementById('forwardListenHost').value = listenHost;
            document.getElementById('forwardListenPort').value = listenPort;
            document.getElementById('forwardRemoteHost').value = remoteHost;
            document.getElementById('forwardRemotePort').value = remotePort;
            document.getElementById('forwardEnabled').value = enabled.toString();
            document.getElementById('forwardModal').classList.add('active');
        }
        document.getElementById('forwardForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('forwardName').value,
                ssh_server_id: document.getElementById('forwardSSHServer').value,
                listen_host: document.getElementById('forwardListenHost').value,
                listen_port: parseInt(document.getElementById('forwardListenPort').value),
                remote_host: document.getElementById('forwardRemoteHost').value,
                remote_port: parseInt(document.getElementById('forwardRemotePort').value),
                enabled: document.getElementById('forwardEnabled').value === 'true'
            };
            const id = document.getElementById('forwardId').value;
            if(id) {
                data.id = id;
                await fetch('/api/port-forwards', { method: 'PUT', body: JSON.stringify(data) });
            } else {
                await fetch('/api/port-forwards', { method: 'POST', body: JSON.stringify(data) });
            }
            closeModal();
            loadData();
        };
        async function deleteForward(id) {
            if(await showConfirm('确定要删除这个端口转发吗?')) {
                await fetch('/api/port-forwards?id=' + id, { method: 'DELETE' });
                loadData();
            }
        }
        loadData();
    </script>
</body>
</html>
