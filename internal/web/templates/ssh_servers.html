<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH服务器 - NetLink</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="/static/logo.svg" alt="NetLink">
            <span class="logo-text">NetLink</span>
        </div>
        <nav class="nav">
            <a href="/">首页</a>
            <a href="/connections">连接</a>
            <a href="/logs">日志</a>
            <a href="/ssh-servers">SSH服务器</a>
            <a href="/port-forwards">端口转发</a>
            <a href="/http-proxy">HTTP代理</a>
        </nav>
    </header>
    <main class="container-full">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2>SSH服务器</h2>
                <button class="btn btn-primary" onclick="openModal()">添加服务器</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>主机</th>
                        <th class="text-right">端口</th>
                        <th>用户名</th>
                        <th class="no-wrap">认证方式</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="serverTable">
                    <tr><td colspan="6" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="modal" id="serverModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加SSH服务器</h3>
                <span style="cursor:pointer" onclick="closeModal()">&times;</span>
            </div>
            <form id="serverForm">
                <input type="hidden" id="serverId">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="serverName" required>
                </div>
                <div class="form-group">
                    <label>主机地址</label>
                    <input type="text" id="serverHost" required>
                </div>
                <div class="form-group">
                    <label>端口</label>
                    <input type="number" id="serverPort" value="22" required>
                </div>
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="serverUsername" required>
                </div>
                <div class="form-group">
                    <label>认证方式</label>
                    <select id="serverAuthType" onchange="updateAuthFields()">
                        <option value="password">密码</option>
                        <option value="key">密钥</option>
                    </select>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label>密码</label>
                    <input type="password" id="serverPassword">
                </div>
                <div class="form-group" id="privateKeyGroup">
                    <label>私钥路径</label>
                    <input type="text" id="serverPrivateKey" placeholder="/path/to/private_key">
                </div>
                <div class="form-group">
                    <label>保活间隔(秒,0表示禁用)</label>
                    <input type="number" id="serverKeepAlive" value="30">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background:#e2e8f0" onclick="closeModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let editingId = null;

        async function loadServers() {
            const servers = await fetch('/api/ssh-servers').then(r => r.json());
            const tbody = document.getElementById('serverTable');
            const serversList = servers || [];
            if(serversList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">暂无SSH服务器</td></tr>';
                return;
            }
            tbody.innerHTML = serversList.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.host}</td>
                    <td class="text-right">${s.port}</td>
                    <td>${s.username}</td>
                    <td class="no-wrap">${s.auth_type}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick="editServer('${s.id}', '${s.name}', '${s.host}', ${s.port}, '${s.username}', '${s.auth_type}', '${s.private_key||''}', ${s.keep_alive_interval})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteServer('${s.id}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        function openModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = '添加SSH服务器';
            document.getElementById('serverForm').reset();
            document.getElementById('serverModal').classList.add('active');
            updateAuthFields();
        }
        function closeModal() {
            document.getElementById('serverModal').classList.remove('active');
        }
        function editServer(id, name, host, port, username, authType, privateKey, keepAlive) {
            editingId = id;
            document.getElementById('modalTitle').textContent = '编辑SSH服务器';
            document.getElementById('serverId').value = id;
            document.getElementById('serverName').value = name;
            document.getElementById('serverHost').value = host;
            document.getElementById('serverPort').value = port;
            document.getElementById('serverUsername').value = username;
            document.getElementById('serverAuthType').value = authType;
            document.getElementById('serverPrivateKey').value = privateKey;
            document.getElementById('serverKeepAlive').value = keepAlive;
            document.getElementById('serverModal').classList.add('active');
            updateAuthFields();
        }
        function updateAuthFields() {
            const authType = document.getElementById('serverAuthType').value;
            const passwordGroup = document.getElementById('passwordGroup');
            const privateKeyGroup = document.getElementById('privateKeyGroup');
            if (authType === 'password') {
                passwordGroup.classList.remove('hidden');
                privateKeyGroup.classList.add('hidden');
            } else {
                passwordGroup.classList.add('hidden');
                privateKeyGroup.classList.remove('hidden');
            }
        }
        document.getElementById('serverForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('serverName').value,
                host: document.getElementById('serverHost').value,
                port: parseInt(document.getElementById('serverPort').value),
                username: document.getElementById('serverUsername').value,
                auth_type: document.getElementById('serverAuthType').value,
                password: document.getElementById('serverPassword').value,
                private_key: document.getElementById('serverPrivateKey').value,
                keep_alive_interval: parseInt(document.getElementById('serverKeepAlive').value)
            };
            if(editingId) {
                data.id = editingId;
                await fetch('/api/ssh-servers', { method: 'PUT', body: JSON.stringify(data) });
            } else {
                await fetch('/api/ssh-servers', { method: 'POST', body: JSON.stringify(data) });
            }
            closeModal();
            loadServers();
            if(editingId) {
                if(await showConfirm('SSH服务器配置已修改，需要重启服务器以使修改生效。是否现在重启？')) {
                    await performRestart();
                }
            } else {
                if(await showConfirm('SSH服务器已添加，需要重启服务器以使修改生效。是否现在重启？')) {
                    await performRestart();
                }
            }
        };
        async function deleteServer(id) {
            if(await showConfirm('确定要删除这个SSH服务器吗?')) {
                await fetch('/api/ssh-servers?id=' + id, { method: 'DELETE' });
                loadServers();
                if(await showConfirm('SSH服务器已删除，需要重启服务器以使修改生效。是否现在重启？')) {
                    await performRestart();
                }
            }
        }
        loadServers();
    </script>
</body>
</html>
