<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP代理 - NetLink</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="/static/logo.svg" alt="NetLink">
            <span class="logo-text">NetLink</span>
        </div>
        <nav class="nav">
            <a href="/">首页</a>
            <a href="/connections">连接</a>
            <a href="/logs">日志</a>
            <a href="/ssh-servers">SSH服务器</a>
            <a href="/port-forwards">端口转发</a>
            <a href="/http-proxy">HTTP代理</a>
        </nav>
    </header>
    <main class="container-full">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2>HTTP代理</h2>
                <button class="btn btn-primary" onclick="openModal()">添加代理</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>监听地址</th>
                        <th>SSH服务器</th>
                        <th class="no-wrap">启用状态</th>
                        <th class="no-wrap">SSH状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="proxyTable">
                    <tr><td colspan="6" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div class="modal" id="proxyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加HTTP代理</h3>
                <span style="cursor:pointer" onclick="closeModal()">&times;</span>
            </div>
            <form id="proxyForm">
                <input type="hidden" id="proxyId">
                <div class="form-group">
                    <label>名称</label>
                    <input type="text" id="proxyName" required>
                </div>
                <div class="form-group">
                    <label>监听地址</label>
                    <input type="text" id="proxyListen" placeholder="0.0.0.0:1080" required>
                </div>
                <div class="form-group">
                    <label>SSH服务器</label>
                    <select id="proxySSHServer">
                        <option value="">默认(第一个可用的)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select id="proxyEnabled">
                        <option value="false">禁用</option>
                        <option value="true">启用</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" style="background:#e2e8f0" onclick="closeModal()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/common.js"></script>
    <script>
        let servers = [];

        async function loadData() {
            const [serversData, proxiesData] = await Promise.all([
                apiCall('/api/ssh-servers'),
                apiCall('/api/http-proxies')
            ]);
            servers = serversData || [];
            renderTable(proxiesData);
        }

        function renderTable(proxies) {
            const proxiesList = proxies || [];
            const tbody = document.getElementById('proxyTable');
            if(proxiesList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">暂无HTTP代理</td></tr>';
                return;
            }
            tbody.innerHTML = proxiesList.map(p => {
                let sshStatusClass = 'status-unknown';
                let sshStatusText = '未知';
                if (p.ssh_server_valid === true) {
                    sshStatusClass = 'status-connected';
                    sshStatusText = '有效';
                } else if (p.ssh_server_valid === false) {
                    sshStatusClass = 'status-invalid';
                    sshStatusText = '无效';
                }
                return `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.listen}</td>
                    <td>${p.ssh_server_name || '默认'}</td>
                    <td class="no-wrap">${p.enabled ? '已启用' : '已禁用'}</td>
                    <td class="no-wrap ${sshStatusClass}">${sshStatusText}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick="editProxy('${p.id}', '${p.name}', '${p.listen}', '${p.ssh_server_id}', ${p.enabled})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteProxy('${p.id}')">删除</button>
                    </td>
                </tr>
            `}).join('');
        }

        function openModal() {
            document.getElementById('modalTitle').textContent = '添加HTTP代理';
            document.getElementById('proxyForm').reset();
            const select = document.getElementById('proxySSHServer');
            select.innerHTML = '<option value="">默认(第一个可用的)</option>' + servers.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            document.getElementById('proxyModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('proxyModal').classList.remove('active');
        }

        function editProxy(id, name, listen, sshServerId, enabled) {
            document.getElementById('modalTitle').textContent = '编辑HTTP代理';
            document.getElementById('proxyId').value = id;
            document.getElementById('proxyName').value = name;
            document.getElementById('proxyListen').value = listen;
            const select = document.getElementById('proxySSHServer');
            select.innerHTML = servers.map(s => 
                `<option value="${s.id}" ${s.id === sshServerId ? 'selected' : ''}>${s.name}</option>`
            ).join('');
            document.getElementById('proxyEnabled').value = enabled.toString();
            document.getElementById('proxyModal').classList.add('active');
        }

        document.getElementById('proxyForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('proxyName').value,
                listen: document.getElementById('proxyListen').value,
                ssh_server_id: document.getElementById('proxySSHServer').value,
                enabled: document.getElementById('proxyEnabled').value === 'true'
            };
            const id = document.getElementById('proxyId').value;
            if(id) {
                data.id = id;
                await apiCall('/api/http-proxies', { method: 'PUT', body: JSON.stringify(data) });
            } else {
                await apiCall('/api/http-proxies', { method: 'POST', body: JSON.stringify(data) });
            }
            closeModal();
            loadData();
        };

        async function deleteProxy(id) {
            if(await showConfirm('确定要删除这个HTTP代理吗?')) {
                await apiCall('/api/http-proxies?id=' + id, { method: 'DELETE' });
                loadData();
            }
        }

        loadData();
    </script>
</body>
</html>
