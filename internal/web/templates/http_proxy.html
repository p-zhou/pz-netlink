<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP代理 - netlink</title>
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="header">
        <h1>netlink</h1>
        <nav class="nav">
            <a href="/">首页</a>
            <a href="/connections">连接</a>
            <a href="/logs">日志</a>
            <a href="/ssh-servers">SSH服务器</a>
            <a href="/port-forwards">端口转发</a>
            <a href="/http-proxy">HTTP代理</a>
        </nav>
    </header>
    <main class="container">
        <div class="card">
            <h2>HTTP代理设置</h2>
            <div class="info-box">
                <p><strong>HTTP代理说明：</strong></p>
                <p>启用HTTP代理后，可通过配置浏览器或系统代理来通过SSH服务器访问网络。</p>
                <p>代理地址: http://[服务器IP]:[监听端口]</p>
            </div>
            <form id="proxyForm">
                <div class="form-group">
                    <label>监听地址</label>
                    <input type="text" id="proxyListen" placeholder="0.0.0.0:1080" required>
                </div>
                <div class="form-group">
                    <label>SSH服务器</label>
                    <select id="proxySSHServer">
                        <option value="">默认(第一个可用的)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select id="proxyEnabled">
                        <option value="false">禁用</option>
                        <option value="true">启用</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">保存配置</button>
            </form>
        </div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        let servers = [];

        async function loadData() {
            const [serversData, proxyData] = await Promise.all([
                fetch('/api/ssh-servers').then(r => r.json()),
                fetch('/api/http-proxy').then(r => r.json())
            ]);
            servers = serversData || [];
            const select = document.getElementById('proxySSHServer');
            select.innerHTML = '<option value="">默认(第一个可用的)</option>' + servers.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            const proxyCfg = proxyData || { enabled: false, listen: '', ssh_server_id: '' };
            document.getElementById('proxyEnabled').value = proxyCfg.enabled.toString();
            document.getElementById('proxyListen').value = proxyCfg.listen;
            document.getElementById('proxySSHServer').value = proxyCfg.ssh_server_id || '';
        }
        document.getElementById('proxyForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                enabled: document.getElementById('proxyEnabled').value === 'true',
                listen: document.getElementById('proxyListen').value,
                ssh_server_id: document.getElementById('proxySSHServer').value
            };
            await fetch('/api/http-proxy', { method: 'PUT', body: JSON.stringify(data) });
            showAlert('配置已保存');
        };
        loadData();
    </script>
</body>
</html>
