<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细连接信息: {{.Connection.Name}} - NetLink</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body>
    <header class="header">
        <div class="logo-container">
            <img src="/static/logo.svg" alt="NetLink">
            <span class="logo-text">NetLink</span>
        </div>
        <nav class="nav">
            <a href="/">首页</a>
            <a href="/connections">连接</a>
            <a href="/logs">日志</a>
            <a href="/ssh-servers">SSH服务器</a>
            <a href="/port-forwards">端口转发</a>
            <a href="/http-proxy">HTTP代理</a>
        </nav>
    </header>
    <main class="container-full" id="mainContainer">
        <div class="card" style="display:flex; flex-direction:column; height:calc(100vh - var(--header-height, 120px));">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-shrink:0;">
                <h2>详细连接信息: {{.Connection.Name}}</h2>
                <button class="btn btn-secondary" onclick="window.close()">关闭</button>
            </div>
            <div style="margin-bottom:1.5rem; padding:1rem; background:#f5f5f5; border-radius:4px; flex-shrink:0;">
                <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:1rem; align-items:center;">
                    <div><strong>类型:</strong> {{if eq .Connection.Type "port_forward"}}端口转发{{else if eq .Connection.Type "http_proxy"}}HTTP代理{{else}}{{.Connection.Type}}{{end}}</div>
                    <div><strong>本地地址:</strong> {{.Connection.LocalAddr}}</div>
                    <div><strong>远程地址:</strong> {{if ne .Connection.RemoteAddr ""}}{{.Connection.RemoteAddr}}{{else}}-{{end}}</div>
                    <div><strong>状态:</strong> <span class="status-{{.Connection.Status}}">{{if eq .Connection.Status "connected"}}已连接{{else if eq .Connection.Status "disconnected"}}已断开{{else if eq .Connection.Status "invalid"}}无效{{else}}{{.Connection.Status}}{{end}}</span></div>
                    {{if eq .Connection.ForwardMode "ssh_cmd"}}
                    <div><strong>接收:</strong> -</div>
                    <div><strong>发送:</strong> -</div>
                    {{else}}
                    <div><strong>接收:</strong> {{formatBytes .Connection.BytesIn}}</div>
                    <div><strong>发送:</strong> {{formatBytes .Connection.BytesOut}}</div>
                    {{end}}
                </div>
                {{if eq .Connection.ForwardMode "ssh_cmd"}}
                <div style="margin-top:0.5rem; padding:0.75rem; background:#e8f4f8; border-radius:4px; border-left:3px solid #009688;">
                    <div><strong>转发方式:</strong> SSH命令</div>
                    <div style="margin-top:0.5rem;">
                        <div style="margin-bottom:0.25rem;"><strong>SSH 命令行:</strong></div>
                        <div style="font-family:monospace; font-size:0.85rem; color:#d32f2f; word-break:break-all; background:#fff; padding:0.5rem; border-radius:3px;">{{.Connection.SSHCommand}}</div>
                    </div>
                </div>
                {{end}}
            </div>
            {{if eq .Connection.ForwardMode "ssh_cmd"}}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-shrink:0;">
                <h3>SSH 日志输出</h3>
                <button class="btn btn-refresh" onclick="loadSSHLogs()">刷新</button>
            </div>
            <div style="flex:1; min-height:0; display:flex; flex-direction:column;">
                <pre id="sshLogs" style="flex:1; background:#1e1e1e; color:#d4d4d4; padding:1rem; border-radius:4px; font-size:0.85rem; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word; margin:0;">加载中...</pre>
            </div>
            {{else}}
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3>活动连接 ({{.Connection.ActiveConnections}})</h3>
                <button class="btn btn-refresh" onclick="loadDetails()">刷新</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>连接ID</th>
                        <th>客户端地址</th>
                        <th id="remoteHostHeader" style="display:none;">远程主机</th>
                        <th>开始时间</th>
                        <th class="no-wrap">持续时间</th>
                    </tr>
                </thead>
                <tbody id="detailsTable">
                    <tr><td colspan="5" style="text-align:center;">加载中...</td></tr>
                </tbody>
            </table>
            {{end}}
        </div>
    </main>
    <script>
        const connectionId = '{{.Connection.ID}}';
        const connectionType = '{{.Connection.Type}}';
        const forwardMode = '{{.Connection.ForwardMode}}';

        function adjustCardHeight() {
            const header = document.querySelector('.header');
            const mainContainer = document.getElementById('mainContainer');
            if (header && mainContainer) {
                const headerHeight = header.offsetHeight;
                const mainMarginTop = parseInt(getComputedStyle(mainContainer).marginTop) || 0;
                const mainMarginBottom = parseInt(getComputedStyle(mainContainer).marginBottom) || 0;
                const totalHeight = headerHeight + mainMarginTop + mainMarginBottom;
                document.documentElement.style.setProperty('--header-height', totalHeight + 'px');
            }
        }

        window.addEventListener('load', adjustCardHeight);
        window.addEventListener('resize', adjustCardHeight);
 
        function formatBytes(b) {
            if(b < 1024) return b + ' B';
            if(b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
            if(b < 1024*1024*1024) return (b/1024/1024).toFixed(1) + ' MB';
            return (b/1024/1024/1024).toFixed(1) + ' GB';
        }
        function formatTime(t) {
            return new Date(t).toLocaleString();
        }
        async function loadDetails() {
            const details = await fetch('/api/connections/details?id=' + connectionId).then(r => r.json());
            const tbody = document.getElementById('detailsTable');
            const remoteHostHeader = document.getElementById('remoteHostHeader');
            const detailsList = details || [];
 
            if (connectionType === 'http_proxy') {
                remoteHostHeader.style.display = '';
            } else {
                remoteHostHeader.style.display = 'none';
            }
 
            if(detailsList.length === 0) {
                const colspan = connectionType === 'http_proxy' ? 5 : 4;
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">暂无活动连接</td></tr>`;
                return;
            }
 
            tbody.innerHTML = detailsList.map(d => {
                const remoteHostCell = connectionType === 'http_proxy' && d.remote_host
                    ? `<td>${d.remote_host}</td>`
                    : '';
                return `
                <tr>
                    <td class="no-wrap" style="font-family:monospace;">${d.id}</td>
                    <td>${d.client_ip}</td>
                    ${remoteHostCell}
                    <td>${formatTime(d.started_at)}</td>
                    <td class="no-wrap">${d.duration}</td>
                </tr>
            `}).join('');
        }
        async function loadSSHLogs() {
            const logsDiv = document.getElementById('sshLogs');
            if (!logsDiv) return;

            const isNearBottom = () => {
                const tolerance = 10;
                const scrollTop = logsDiv.scrollTop;
                const scrollHeight = logsDiv.scrollHeight;
                const clientHeight = logsDiv.clientHeight;
                return scrollHeight - (scrollTop + clientHeight) <= tolerance;
            };

            const shouldAutoScroll = isNearBottom();

            try {
                const logs = await fetch('/api/connections/ssh-logs?id=' + connectionId).then(r => r.text());
                logsDiv.textContent = logs || '暂无日志';

                if (shouldAutoScroll) {
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }
            } catch (error) {
                logsDiv.textContent = '加载日志失败: ' + error.message;
            }
        }
        {{if ne .Connection.ForwardMode "ssh_cmd"}}
        loadDetails();
        setInterval(loadDetails, 5000);
        {{else}}
        loadSSHLogs();
        setInterval(loadSSHLogs, 5000);
        {{end}}
    </script>
</body>
</html>
